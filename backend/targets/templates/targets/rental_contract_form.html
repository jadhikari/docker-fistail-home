{% extends "base.html" %}
{% load static %}

{% block title %}{{ title }} - Fishtail System{% endblock %}

{% block content %}
<div class="container-fluid py-2">
    
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <h5 class="mb-0">
                <i class="bi bi-plus-circle text-success me-2"></i>Add Achievement
            </h5>
            <small class="text-muted">Create a new rental contract for your current month target</small>
        </div>
        <div>
            <a href="{% url 'targets:profile' %}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <!-- Error messages -->
    {% if messages %}
        <div class="mb-2">
            <div class="alert alert-{{ message.tags }} alert-danger fade show auto-dismiss py-2" role="alert">
                {% for message in messages %}
                    <i class="bi bi-info-circle me-2"></i>{{ message }}<br>
            {% endfor %}
            </div>
        </div>
    {% endif %}

    <!-- Achievement Rules Info -->
    {% if current_target %}
        <div class="alert alert-info mb-2 py-2">
            <div class="d-flex align-items-center">
                <i class="bi bi-info-circle me-2"></i>
                <div>
                    <strong>Current Month Target:</strong> {{ current_target.target_period }} - ¥{{ current_target.target_amount|floatformat:0 }}
                    <br><small class="text-muted">Target is automatically set and cannot be changed.</small>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Form Section -->
    <div class="card">
        <div class="card-header py-2">
            <h6 class="mb-0">
                <i class="bi bi-file-earmark-text"></i> Rental Contract Information
            </h6>
        </div>
        <div class="card-body py-3">
            
            <form method="post" novalidate>
                {% csrf_token %}
                
                <!-- Target Information (Read-only) -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold small">Target Period</label>
                        <input type="text" class="form-control form-control-sm bg-light" value="{{ current_target.target_period }}" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold small">Target Amount</label>
                        <input type="text" class="form-control form-control-sm bg-light" value="¥{{ current_target.target_amount|floatformat:0 }}" readonly>
                    </div>
                </div>

                <!-- Customer & Property Information -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.customer_name.id_for_label }}" class="form-label fw-semibold small">
                            Customer Name <span class="text-danger">*</span>
                        </label>
                        {{ form.customer_name }}
                        {% if form.customer_name.errors %}
                            <div class="text-danger small mt-1">{{ form.customer_name.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.customer_number.id_for_label }}" class="form-label fw-semibold small">
                            Phone Number <span class="text-danger">*</span>
                        </label>
                        {{ form.customer_number }}
                        {% if form.customer_number.errors %}
                            <div class="text-danger small mt-1">{{ form.customer_number.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="{{ form.contract_date.id_for_label }}" class="form-label fw-semibold small">
                            Contract Date <span class="text-danger">*</span>
                        </label>
                        {{ form.contract_date }}
                        {% if form.contract_date.errors %}
                            <div class="text-danger small mt-1">{{ form.contract_date.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.living_num_people.id_for_label }}" class="form-label fw-semibold small">
                            Number of People <span class="text-danger">*</span>
                        </label>
                        {{ form.living_num_people }}
                        {% if form.living_num_people.errors %}
                            <div class="text-danger small mt-1">{{ form.living_num_people.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.contract_type.id_for_label }}" class="form-label fw-semibold small">
                            Contract Type <span class="text-danger">*</span>
                        </label>
                        {{ form.contract_type }}
                        {% if form.contract_type.errors %}
                            <div class="text-danger small mt-1">{{ form.contract_type.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-12">
                        <label for="{{ form.building_address.id_for_label }}" class="form-label fw-semibold small">
                            Building Address <span class="text-danger">*</span>
                        </label>
                        {{ form.building_address }}
                        {% if form.building_address.errors %}
                            <div class="text-danger small mt-1">{{ form.building_address.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Financial Information -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="{{ form.agent_fee.id_for_label }}" class="form-label fw-semibold small">
                            Agent Fee <span class="text-danger">*</span>
                        </label>
                        {{ form.agent_fee }}
                        {% if form.agent_fee.errors %}
                            <div class="text-danger small mt-1">{{ form.agent_fee.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ form.ad_fee.id_for_label }}" class="form-label fw-semibold small">
                            Ad Fee <span class="text-danger">*</span>
                        </label>
                        {{ form.ad_fee }}
                        {% if form.ad_fee.errors %}
                            <div class="text-danger small mt-1">{{ form.ad_fee.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ form.deposit_fee.id_for_label }}" class="form-label fw-semibold small">
                            Deposit <span class="text-danger">*</span>
                        </label>
                        {{ form.deposit_fee }}
                        {% if form.deposit_fee.errors %}
                            <div class="text-danger small mt-1">{{ form.deposit_fee.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ form.renew_fee.id_for_label }}" class="form-label fw-semibold small">
                            Renewal Fee <span class="text-danger">*</span>
                        </label>
                        {{ form.renew_fee }}
                        {% if form.renew_fee.errors %}
                            <div class="text-danger small mt-1">{{ form.renew_fee.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Contract & Payment Details -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="{{ form.rent_payment_date.id_for_label }}" class="form-label fw-semibold small">
                            Rent Payment Date <span class="text-danger">*</span>
                        </label>
                        {{ form.rent_payment_date }}
                        {% if form.rent_payment_date.errors %}
                            <div class="text-danger small mt-1">{{ form.rent_payment_date.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.cancellation_notice_period.id_for_label }}" class="form-label fw-semibold small">
                            Notice Period <span class="text-danger">*</span>
                        </label>
                        {{ form.cancellation_notice_period }}
                        {% if form.cancellation_notice_period.errors %}
                            <div class="text-danger small mt-1">{{ form.cancellation_notice_period.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.cancellation_charge.id_for_label }}" class="form-label fw-semibold small">
                            Cancellation Charge <span class="text-danger">*</span>
                        </label>
                        {{ form.cancellation_charge }}
                        {% if form.cancellation_charge.errors %}
                            <div class="text-danger small mt-1">{{ form.cancellation_charge.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.cancellation_period.id_for_label }}" class="form-label fw-semibold small">
                            Cancellation Period <span class="text-danger">*</span>
                        </label>
                        {{ form.cancellation_period }}
                        {% if form.cancellation_period.errors %}
                            <div class="text-danger small mt-1">{{ form.cancellation_period.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <div class="form-check mt-4">
                            {{ form.cleaning_charge }}
                            <label class="form-check-label fw-semibold small" for="{{ form.cleaning_charge.id_for_label }}">
                                Cleaning Charge Applicable
                            </label>
                        </div>
                        {% if form.cleaning_charge.errors %}
                            <div class="text-danger small mt-1">{{ form.cleaning_charge.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.support_phone.id_for_label }}" class="form-label fw-semibold small">
                            Support Phone <span class="text-danger">*</span>
                        </label>
                        {{ form.support_phone }}
                        {% if form.support_phone.errors %}
                            <div class="text-danger small mt-1">{{ form.support_phone.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.emergency_contact_person.id_for_label }}" class="form-label fw-semibold small">
                            Emergency Contact <span class="text-danger">*</span>
                        </label>
                        {{ form.emergency_contact_person }}
                        {% if form.emergency_contact_person.errors %}
                            <div class="text-danger small mt-1">{{ form.emergency_contact_person.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.emergency_phone.id_for_label }}" class="form-label fw-semibold small">
                            Emergency Phone <span class="text-danger">*</span>
                        </label>
                        {{ form.emergency_phone }}
                        {% if form.emergency_phone.errors %}
                            <div class="text-danger small mt-1">{{ form.emergency_phone.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.management_company_name.id_for_label }}" class="form-label fw-semibold small">
                            Management Company <span class="text-danger">*</span>
                        </label>
                        {{ form.management_company_name }}
                        {% if form.management_company_name.errors %}
                            <div class="text-danger small mt-1">{{ form.management_company_name.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.management_company_phone_number.id_for_label }}" class="form-label fw-semibold small">
                            Management Phone <span class="text-danger">*</span>
                        </label>
                        {{ form.management_company_phone_number }}
                        {% if form.management_company_phone_number.errors %}
                            <div class="text-danger small mt-1">{{ form.management_company_phone_number.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.memo.id_for_label }}" class="form-label fw-semibold small">
                            Memo/Notes
                        </label>
                        {{ form.memo }}
                        {% if form.memo.errors %}
                            <div class="text-danger small mt-1">{{ form.memo.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="d-flex gap-2 justify-content-end mt-3">
                    <button type="submit" class="btn btn-success btn-sm">
                        <i class="bi bi-check-circle me-1"></i> Add Achievement
                    </button>
                    <a href="{% url 'targets:profile' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-x-circle me-1"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Auto-dismiss alerts
    setTimeout(() => {
        document.querySelectorAll('.auto-dismiss').forEach(alert => {
            const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
            bsAlert.close();
        });
    }, 5000);
</script>

{% endblock %} 
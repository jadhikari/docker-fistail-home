{% extends "base.html" %}

{% block title %}Hostel Dashboard{% endblock %}

{% block content %}
<style>
    #hostel-table-wrapper {
      height: 45vh;
      overflow-y: auto;
    }
    #map {
      height: 50vh;
      width: 100%;
    }
</style>
<div class="container-fluid py-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Hostel Dashboard</h4>
      {% comment %} <a href="{% url 'hostel_add' %}" class="btn btn-primary">Add Hostel</a> {% endcomment %}
    </div>
  
    <div id="hostel-table-wrapper" class="table-responsive border rounded">
      <table class="table table-sm table-striped table-bordered text-center">
        <thead class="table-dark">
          <tr>
            <th>Name</th>
            <th>Common Name</th>
            <th>Type</th>
            <th>Total Rooms</th>
            <th>Address</th>
            <th>Latitude</th>
            <th>Longitude</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Rent</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for hostel in hostels %}
          <tr data-name="{{ hostel.name }}" data-lat="{{ hostel.latitude }}" data-lng="{{ hostel.longitude }}">
            <td><a href="{% url 'hostel:hostel_detail' hostel.id %}" class="text-decoration-none fw-bold">{{ hostel.name }}</a></td>
            <td>{{ hostel.common_name }}</td>
            <td>{{ hostel.get_hostel_type_display }}</td>
            <td>{{ hostel.total_rooms }}</td>
            <td>{{ hostel.address }}</td>
            <td>{{ hostel.latitude }}</td>
            <td>{{ hostel.longitude }}</td>
            <td>{{ hostel.contract_start_date }}</td>
            <td>{{ hostel.contract_end_date }}</td>
            <td>{{ hostel.rent }}</td>
            {% comment %} <td><a href="{% url 'hostel_edit' hostel.id %}" class="btn btn-sm btn-warning">Edit</a></td> {% endcomment %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div id="map" class="mt-3"></div>
  </div>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const map = L.map('map').setView([35.6895, 139.6917], 5);
  
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
      }).addTo(map);
  
      const rows = document.querySelectorAll("tbody tr");
      let markers = [];
  
      rows.forEach(row => {
        const lat = parseFloat(row.dataset.lat);
        const lng = parseFloat(row.dataset.lng);
        const name = row.dataset.name;
  
        if (!isNaN(lat) && !isNaN(lng)) {
          console.log(`Placing marker for: ${name} (${lat}, ${lng})`);
          const marker = L.marker([lat, lng]).addTo(map);
          marker.bindTooltip(name, { permanent: false, direction: "top" });
  
          marker.on("mouseover", () => {
            row.style.backgroundColor = "#e0f7fa";
          });
          marker.on("mouseout", () => {
            row.style.backgroundColor = "";
          });
  
          markers.push([lat, lng]);
        }
      });
  
      // Auto zoom to fit all markers
      if (markers.length) {
        map.fitBounds(markers);
      }
  
      // Allow clicking on map to place a new marker
      map.on('click', function(e) {
        const { lat, lng } = e.latlng;
        L.marker([lat, lng]).addTo(map).bindPopup(`New Point: ${lat.toFixed(5)}, ${lng.toFixed(5)}`).openPopup();
        map.panTo([lat, lng]);
      });
    });
  </script>
  

  

  
{% endblock %}

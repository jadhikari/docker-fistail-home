{% extends 'base.html' %}
{% load static %}
{% load keisan_filters %}

{% block title %}Transaction Details Report{% endblock %}

{% block extra_css %}
<style>
    /* Classical, clean, responsive design */
    .container-fluid {
        padding: 15px;
    }
    
    .card {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 12px 15px;
        font-weight: 600;
    }
    
    .card-body {
        padding: 15px;
    }
    
    .summary-card {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-bottom: 15px;
        background: #fff;
    }
    
    .summary-card .card-body {
        padding: 15px;
        text-align: center;
    }
    
    .summary-card h6 {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 8px;
        color: #6c757d;
    }
    
    .summary-card h4 {
        font-size: 1.4rem;
        font-weight: 700;
        margin: 0;
    }
    
    .table {
        margin-bottom: 0;
        font-size: 0.9rem;
    }
    
    .table th {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 4px 3px;
        font-weight: 600;
        font-size: 0.75rem;
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
    }
    
    .table td {
        border: 1px solid #dee2e6;
        padding: 3px 2px;
        text-align: center;
        vertical-align: middle;
        font-size: 0.75rem;
        white-space: nowrap;
    }
    
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0,0,0,0.02);
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(0,0,0,0.05);
    }
    
    .table-responsive {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        overflow-x: auto;
    }
    
    /* Specific styles for monthly breakdown tables */
    .monthly-breakdown-table th,
    .monthly-breakdown-table td {
        padding: 2px 1px;
        font-size: 0.7rem;
        white-space: nowrap;
        min-width: 60px;
    }
    
    .monthly-breakdown-table th {
        font-size: 0.65rem;
        padding: 3px 1px;
    }
    
    /* Compact table styles for better display */
    .table-compact th,
    .table-compact td {
        padding: 2px 1px;
        font-size: 0.7rem;
        white-space: nowrap;
    }
    
    .table-compact th {
        font-size: 0.65rem;
        padding: 3px 1px;
    }
    
    /* Ensure tables fit properly */
    .table {
        table-layout: auto;
        width: 100%;
    }
    
    .table th:first-child,
    .table td:first-child {
        min-width: 80px;
    }
    
    
    
    .btn {
        font-size: 0.8rem;
        padding: 6px 12px;
        border-radius: 3px;
    }
    
    .btn-sm {
        font-size: 0.75rem;
        padding: 4px 8px;
    }
    
    .form-control, .form-select {
        font-size: 0.9rem;
        padding: 6px 10px;
        border: 1px solid #ced4da;
        border-radius: 3px;
    }
    
    .alert {
        font-size: 0.9rem;
        padding: 10px 15px;
        border-radius: 3px;
        margin-bottom: 15px;
    }
    
    .badge {
        font-size: 0.75rem;
        padding: 4px 8px;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
        .container-fluid {
            padding: 10px;
        }
        
        .card-body {
            padding: 12px;
        }
        
        .summary-card .card-body {
            padding: 12px;
        }
        
        .summary-card h6 {
            font-size: 0.8rem;
        }
        
        .summary-card h4 {
            font-size: 1.2rem;
        }
        
        .table {
            font-size: 0.8rem;
        }
        
        .table th, .table td {
            padding: 3px 2px;
            font-size: 0.7rem;
        }
        
        .btn {
            font-size: 0.75rem;
            padding: 5px 10px;
        }
    }
    
    @media (max-width: 576px) {
        .container-fluid {
            padding: 8px;
        }
        
        .card-body {
            padding: 10px;
        }
        
        .summary-card .card-body {
            padding: 10px;
        }
        
        .summary-card h6 {
            font-size: 0.75rem;
        }
        
        .summary-card h4 {
            font-size: 1.1rem;
        }
        
        .table {
            font-size: 0.75rem;
        }
        
        .table th, .table td {
            padding: 2px 1px;
            font-size: 0.65rem;
        }
        
        .btn {
            font-size: 0.7rem;
            padding: 4px 8px;
        }
        
        .form-control, .form-select {
            font-size: 0.8rem;
            padding: 5px 8px;
        }
    }
    
    /* Print styles */
    @media print {
        .card {
            border: 1px solid #000;
            box-shadow: none;
        }
        
        .table th, .table td {
            border: 1px solid #000;
        }
        
        .btn {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Transaction Details Report
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Search Form -->
                    <form method="get" class="mb-4">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="{{ form.business.id_for_label }}" class="form-label">Business</label>
                                {{ form.business }}
                            </div>
                            <div class="col-md-3">
                                <label for="{{ form.from_period.id_for_label }}" class="form-label">From Period</label>
                                {{ form.from_period }}
                                {% if form.from_period.help_text %}
                                    <small class="form-text text-muted">{{ form.from_period.help_text }}</small>
                                {% endif %}
                            </div>
                            <div class="col-md-3">
                                <label for="{{ form.to_period.id_for_label }}" class="form-label">To Period</label>
                                {{ form.to_period }}
                                {% if form.to_period.help_text %}
                                    <small class="form-text text-muted">{{ form.to_period.help_text }}</small>
                                {% endif %}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search"></i> Search
                                    </button>
                                    {% if show_results and business %}
                                    <button type="button" class="btn btn-success" onclick="downloadExcel()">
                                        <i class="fas fa-download"></i> Download Excel
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </form>

                    {% if show_results and business %}
                        <!-- Business Information Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-building me-2"></i>
                                    Business Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-primary">Business Details</h6>
                                        <table class="table table-sm">
                                            <tr>
                                                <td><strong>Name:</strong></td>
                                                <td>{{ business_info.name }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Registration Number:</strong></td>
                                                <td>{{ business_info.registration_number }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Business Type:</strong></td>
                                                <td>{{ business_info.business_type }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Industry Category:</strong></td>
                                                <td>{{ business_info.industry_category|default:"N/A" }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Email:</strong></td>
                                                <td>{{ business_info.email }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Phone:</strong></td>
                                                <td>{{ business_info.phone }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Website:</strong></td>
                                                <td>{{ business_info.website|default:"N/A" }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Address:</strong></td>
                                                <td>{{ business_info.address|default:"N/A" }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Tax Number:</strong></td>
                                                <td>{{ business_info.tax_number|default:"N/A" }}</td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-primary">Owner Information</h6>
                                        <table class="table table-sm">
                                            <tr>
                                                <td><strong>Owner Name:</strong></td>
                                                <td>{{ business_info.owner_name }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Owner Contact:</strong></td>
                                                <td>{{ business_info.owner_contact_number|default:"N/A" }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Owner Email:</strong></td>
                                                <td>{{ business_info.owner_email|default:"N/A" }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Owner Address:</strong></td>
                                                <td>{{ business_info.owner_address|default:"N/A" }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Office Rent:</strong></td>
                                                <td>¥{{ business_info.office_rent|floatformat:2 }}</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Salary Sheet Section -->
                        {% if salary_sheet %}
                        <div class="card mb-4">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">
                                    <i class="fas fa-users me-2"></i>
                                    Staff Salary Sheet
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive overflow-auto">
                                    <table class="table table-hover table-bordered monthly-breakdown-table table-sm">
                                        <thead class="table-warning">
                                            <tr>
                                                <th class="text-center">Staff Name</th>
                                                <th class="text-center">Employment Type</th>
                                                {% for year, month in months_in_range %}
                                                <th class="text-center">
                                                    {% if month == 1 %}Jan{% elif month == 2 %}Feb{% elif month == 3 %}Mar{% elif month == 4 %}Apr{% elif month == 5 %}May{% elif month == 6 %}Jun{% elif month == 7 %}Jul{% elif month == 8 %}Aug{% elif month == 9 %}Sep{% elif month == 10 %}Oct{% elif month == 11 %}Nov{% elif month == 12 %}Dec{% endif %} {{ year }}
                                                </th>
                                                {% endfor %}
                                                <th class="text-center">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for staff_data in salary_sheet %}
                                            <tr>
                                                <td class="text-center">
                                                    <strong>{{ staff_data.staff.full_name }}</strong>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-secondary">{{ staff_data.employment_type }}</span>
                                                </td>
                                                {% for year, month in months_in_range %}
                                                <td class="text-center">
                                                    {% for month_key, salary_info in staff_data.monthly_salaries.items %}
                                                        {% if salary_info.year == year and salary_info.month == month %}
                                                            {% if salary_info.is_active %}
                                                                <span class="badge bg-success fs-6">¥{{ salary_info.amount|floatformat:2 }}</span>
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </td>
                                                {% endfor %}
                                                <td class="text-center">
                                                    <strong class="text-warning fs-5">
                                                        ¥{{ staff_data.staff.salary|floatformat:2 }}
                                                    </strong>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Business Revenue Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-money-bill-wave me-2"></i>
                                    Business Revenue - Monthly Breakdown
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card summary-card bg-light border-success">
                                            <div class="card-body text-center">
                                                <h6 class="card-title text-success">Total Revenue</h6>
                                                <h4 class="text-success">¥{{ business_revenue.total_amount|floatformat:2 }}</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card bg-light border-primary">
                                            <div class="card-body text-center">
                                                <h6 class="card-title text-primary">Online Revenue</h6>
                                                <h4 class="text-primary">¥{{ business_revenue.online_total|floatformat:2 }}</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card bg-light border-info">
                                            <div class="card-body text-center">
                                                <h6 class="card-title text-info">Offline Revenue</h6>
                                                <h4 class="text-info">¥{{ business_revenue.offline_total|floatformat:2 }}</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card bg-light border-secondary">
                                            <div class="card-body text-center">
                                                <h6 class="card-title text-secondary">Transactions</h6>
                                                <h4 class="text-secondary">{{ business_revenue.transactions.count }}</h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                {% if business_revenue.table_data %}
                                    <div class="table-responsive overflow-auto">
                                        <table class="table table-bordered table-striped table-sm">
                                            <thead class="table-success">
                                                <tr>
                                                    <th class="text-center" rowspan="2">Date</th>
                                                    <th class="text-center" colspan="{{ business_revenue.online_titles|length|add:1 }}">online</th>
                                                    <th class="text-center" colspan="{{ business_revenue.offline_titles|length|add:1 }}">offline</th>
                                                    <th class="text-center" rowspan="2">A+B</th>
                                                </tr>
                                                <tr>
                                                    {% for title in business_revenue.online_titles %}
                                                    <th class="text-center">{{ title }}</th>
                                                    {% endfor %}
                                                    <th class="text-center">Total(A)</th>
                                                    {% for title in business_revenue.offline_titles %}
                                                    <th class="text-center">{{ title }}</th>
                                                    {% endfor %}
                                                    <th class="text-center">Total(B)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for row in business_revenue.table_data %}
                                                <tr>
                                                    <td class="text-center"><strong>{{ row.date }}</strong></td>
                                                    {% for title in business_revenue.online_titles %}
                                                    <td class="text-center">¥{{ row.online_titles|lookup:title|floatformat:2 }}</td>
                                                    {% endfor %}
                                                    <td class="text-center"><strong>¥{{ row.online_total|floatformat:2 }}</strong></td>
                                                    {% for title in business_revenue.offline_titles %}
                                                    <td class="text-center">¥{{ row.offline_titles|lookup:title|floatformat:2 }}</td>
                                                    {% endfor %}
                                                    <td class="text-center"><strong>¥{{ row.offline_total|floatformat:2 }}</strong></td>
                                                    <td class="text-center"><strong>¥{{ row.grand_total|floatformat:2 }}</strong></td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        No revenue transactions found for the selected period.
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Business Expenses Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-receipt me-2"></i>
                                    Business Expenses - Monthly Breakdown
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card summary-card bg-light border-danger">
                                            <div class="card-body text-center">
                                                <h6 class="card-title text-danger">Total Expenses</h6>
                                                <h4 class="text-danger">¥{{ business_expenses.total_amount|floatformat:2 }}</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card bg-light border-primary">
                                            <div class="card-body text-center">
                                                <h6 class="card-title text-primary">Online Expenses</h6>
                                                <h4 class="text-primary">¥{{ business_expenses.online_total|floatformat:2 }}</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card bg-light border-info">
                                            <div class="card-body text-center">
                                                <h6 class="card-title text-info">Offline Expenses</h6>
                                                <h4 class="text-info">¥{{ business_expenses.offline_total|floatformat:2 }}</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card bg-light border-secondary">
                                            <div class="card-body text-center">
                                                <h6 class="card-title text-secondary">Transactions</h6>
                                                <h4 class="text-secondary">{{ business_expenses.transactions|length }}</h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                {% if business_expenses.table_data %}
                                    <div class="table-responsive overflow-auto">
                                        <table class="table table-bordered table-striped table-sm">
                                            <thead class="table-danger">
                                                <tr>
                                                    <th class="text-center" rowspan="2">Date</th>
                                                    <th class="text-center" colspan="{{ business_expenses.online_titles|length|add:1 }}">online</th>
                                                    <th class="text-center" colspan="{{ business_expenses.offline_titles|length|add:1 }}">offline</th>
                                                    <th class="text-center" rowspan="2">Rent</th>
                                                    <th class="text-center" rowspan="2">A+B+Rent</th>
                                                </tr>
                                                <tr>
                                                    {% for title in business_expenses.online_titles %}
                                                    <th class="text-center">{{ title }}</th>
                                                    {% endfor %}
                                                    <th class="text-center">Total(A)</th>
                                                    {% for title in business_expenses.offline_titles %}
                                                    <th class="text-center">{{ title }}</th>
                                                    {% endfor %}
                                                    <th class="text-center">Total(B)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for row in business_expenses.table_data %}
                                                <tr>
                                                    <td class="text-center"><strong>{{ row.date }}</strong></td>
                                                    {% for title in business_expenses.online_titles %}
                                                    <td class="text-center">¥{{ row.online_titles|lookup:title|floatformat:2 }}</td>
                                                    {% endfor %}
                                                    <td class="text-center"><strong>¥{{ row.online_total|floatformat:2 }}</strong></td>
                                                    {% for title in business_expenses.offline_titles %}
                                                    <td class="text-center">¥{{ row.offline_titles|lookup:title|floatformat:2 }}</td>
                                                    {% endfor %}
                                                    <td class="text-center"><strong>¥{{ row.offline_total|floatformat:2 }}</strong></td>
                                                    <td class="text-center">¥{{ row.rent_amount|floatformat:2 }}</td>
                                                    <td class="text-center"><strong>¥{{ row.grand_total|floatformat:2 }}</strong></td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Shops Section -->
                        {% if shops_data %}
                            {% for shop_data in shops_data %}
                            <div class="card mb-4">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-store me-2"></i>
                                        Shop: {{ shop_data.shop_info.name }}
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <!-- Shop Information -->
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <h6 class="text-info">Shop Details</h6>
                                            <table class="table table-sm">
                                                <tr>
                                                    <td><strong>Name:</strong></td>
                                                    <td>{{ shop_data.shop_info.name }}</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Permit ID:</strong></td>
                                                    <td>{{ shop_data.shop_info.permit_id }}</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Shop Type:</strong></td>
                                                    <td>{{ shop_data.shop_info.shop_type }}</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Address:</strong></td>
                                                    <td>{{ shop_data.shop_info.address|default:"N/A" }}</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Shop Rent:</strong></td>
                                                    <td>¥{{ shop_data.shop_info.shop_rent|floatformat:2 }}</td>
                                                </tr>
                                            </table>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-info">Financial Summary</h6>
                                            <div class="row">
                                                <div class="col-6">
                                                    <div class="card bg-light">
                                                        <div class="card-body text-center">
                                                            <h6 class="card-title">Revenue</h6>
                                                            <h5 class="text-success">¥{{ shop_data.revenue.total_amount|floatformat:2 }}</h5>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="card bg-light">
                                                        <div class="card-body text-center">
                                                            <h6 class="card-title">Expenses</h6>
                                                            <h5 class="text-danger">¥{{ shop_data.expenses.total_amount|floatformat:2 }}</h5>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-12">
                                                    <div class="card bg-light">
                                                        <div class="card-body text-center">
                                                            <h6 class="card-title">Net Profit</h6>
                                                            <h5 class="{% if shop_data.revenue.total_amount > shop_data.expenses.total_amount %}text-success{% else %}text-danger{% endif %}">
                                                                ¥{{ shop_data.revenue.total_amount|subtract:shop_data.expenses.total_amount|floatformat:2 }}
                                                            </h5>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>


                                    <!-- Shop Revenue - Detailed Table -->
                                    <div class="card mb-3">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-chart-line me-2"></i>
                                                Shop Revenue - Detailed Breakdown
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                    {% if shop_data.revenue.table_data %}
                                        <div class="table-responsive overflow-auto">
                                            <table class="table table-bordered table-striped table-sm">
                                                <thead class="table-success">
                                                    <tr>
                                                        <th class="text-center" rowspan="2">Date</th>
                                                        <th class="text-center" colspan="{{ shop_data.revenue.online_titles|length|add:1 }}">online</th>
                                                        <th class="text-center" colspan="{{ shop_data.revenue.offline_titles|length|add:1 }}">offline</th>
                                                        <th class="text-center" rowspan="2">A+B</th>
                                                    </tr>
                                                    <tr>
                                                        {% for title in shop_data.revenue.online_titles %}
                                                        <th class="text-center">{{ title }}</th>
                                                                                                {% endfor %}
                                                        <th class="text-center">Total(A)</th>
                                                        {% for title in shop_data.revenue.offline_titles %}
                                                        <th class="text-center">{{ title }}</th>
                                                                                    {% endfor %}
                                                        <th class="text-center">Total(B)</th>
                                                                                    </tr>
                                                                                </thead>
                                                                                <tbody>
                                                    {% for row in shop_data.revenue.table_data %}
                                                    <tr>
                                                        <td class="text-center"><strong>{{ row.date }}</strong></td>
                                                        {% for title in shop_data.revenue.online_titles %}
                                                        <td class="text-center">¥{{ row.online_titles|lookup:title|floatformat:2 }}</td>
                                                                                                {% endfor %}
                                                        <td class="text-center"><strong>¥{{ row.online_total|floatformat:2 }}</strong></td>
                                                        {% for title in shop_data.revenue.offline_titles %}
                                                        <td class="text-center">¥{{ row.offline_titles|lookup:title|floatformat:2 }}</td>
                                                                                    {% endfor %}
                                                        <td class="text-center"><strong>¥{{ row.offline_total|floatformat:2 }}</strong></td>
                                                        <td class="text-center"><strong>¥{{ row.grand_total|floatformat:2 }}</strong></td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            No revenue transactions found for the selected period.
                                        </div>
                                    {% endif %}
                                        </div>
                                    </div>


                                    <!-- Shop Expenses - Detailed Table -->
                                    <div class="card mb-3">
                                        <div class="card-header bg-danger text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-receipt me-2"></i>
                                                Shop Expenses - Detailed Breakdown
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                    {% if shop_data.expenses.table_data %}
                                        <div class="table-responsive overflow-auto">
                                            <table class="table table-bordered table-striped table-sm">
                                                <thead class="table-danger">
                                                    <tr>
                                                        <th class="text-center" rowspan="2">Date</th>
                                                        <th class="text-center" colspan="{{ shop_data.expenses.online_titles|length|add:1 }}">online</th>
                                                        <th class="text-center" colspan="{{ shop_data.expenses.offline_titles|length|add:1 }}">offline</th>
                                                        <th class="text-center" rowspan="2">Rent</th>
                                                        <th class="text-center" rowspan="2">A+B+Rent</th>
                                                    </tr>
                                                    <tr>
                                                        {% for title in shop_data.expenses.online_titles %}
                                                        <th class="text-center">{{ title }}</th>
                                                                                                {% endfor %}
                                                        <th class="text-center">Total(A)</th>
                                                        {% for title in shop_data.expenses.offline_titles %}
                                                        <th class="text-center">{{ title }}</th>
                                                                                    {% endfor %}
                                                        <th class="text-center">Total(B)</th>
                                                                                    </tr>
                                                                                </thead>
                                                                                <tbody>
                                                    {% for row in shop_data.expenses.table_data %}
                                                    <tr>
                                                        <td class="text-center"><strong>{{ row.date }}</strong></td>
                                                        {% for title in shop_data.expenses.online_titles %}
                                                        <td class="text-center">¥{{ row.online_titles|lookup:title|floatformat:2 }}</td>
                                                                                                {% endfor %}
                                                        <td class="text-center"><strong>¥{{ row.online_total|floatformat:2 }}</strong></td>
                                                        {% for title in shop_data.expenses.offline_titles %}
                                                        <td class="text-center">¥{{ row.offline_titles|lookup:title|floatformat:2 }}</td>
                                                                                    {% endfor %}
                                                        <td class="text-center"><strong>¥{{ row.offline_total|floatformat:2 }}</strong></td>
                                                        <td class="text-center">¥{{ row.rent_amount|floatformat:2 }}</td>
                                                        <td class="text-center"><strong>¥{{ row.grand_total|floatformat:2 }}</strong></td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% endif %}
                                        </div>
                                    </div>

                                    <!-- Shop Salary Sheet Section -->
                                    {% if shop_data.salary_sheet %}
                                    <div class="mb-4">
                                        <h6 class="text-warning mb-3">
                                            <i class="fas fa-users me-2"></i>Shop Staff Salary Sheet
                                        </h6>
                                        <div class="table-responsive overflow-auto">
                                            <table class="table table-hover table-bordered monthly-breakdown-table table-sm">
                                                <thead class="table-warning">
                                                    <tr>
                                                        <th class="text-center">Staff Name</th>
                                                        <th class="text-center">Employment Type</th>
                                                        {% for year, month in months_in_range %}
                                                        <th class="text-center">
                                                            {% if month == 1 %}Jan{% elif month == 2 %}Feb{% elif month == 3 %}Mar{% elif month == 4 %}Apr{% elif month == 5 %}May{% elif month == 6 %}Jun{% elif month == 7 %}Jul{% elif month == 8 %}Aug{% elif month == 9 %}Sep{% elif month == 10 %}Oct{% elif month == 11 %}Nov{% elif month == 12 %}Dec{% endif %} {{ year }}
                                                        </th>
                                                        {% endfor %}
                                                        <th class="text-center">Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for staff_data in shop_data.salary_sheet %}
                                                    <tr>
                                                        <td class="text-center">
                                                            <strong>{{ staff_data.staff.full_name }}</strong>
                                                        </td>
                                                        <td class="text-center">
                                                            <span class="badge bg-secondary">{{ staff_data.employment_type }}</span>
                                                        </td>
                                                        {% for year, month in months_in_range %}
                                                        <td class="text-center">
                                                            {% for month_key, salary_info in staff_data.monthly_salaries.items %}
                                                                {% if salary_info.year == year and salary_info.month == month %}
                                                                    {% if salary_info.is_active %}
                                                                        <span class="badge bg-success fs-6">¥{{ salary_info.amount|floatformat:2 }}</span>
                                                                {% else %}
                                                                        <span class="text-muted">-</span>
                                                                {% endif %}
                                                                    {% endif %}
                                                                {% endfor %}
                                                        </td>
                                                        {% endfor %}
                                                        <td class="text-center">
                                                            <strong class="text-warning fs-5">
                                                                ¥{{ staff_data.staff.salary|floatformat:2 }}
                                                            </strong>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- Shop Staff -->
                                    {% if shop_data.staff %}
                                    <div class="mb-3">
                                        <h6 class="text-warning">Shop Staff:</h6>
                                        <div class="table-responsive overflow-auto">
                                            <table class="table table-striped table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Name</th>
                                                        <th>Role</th>
                                                        <th>Employment Type</th>
                                                        <th>Start Date</th>
                                                        <th>End Date</th>
                                                        <th>Status</th>
                                                        <th>Salary</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for staff_data in shop_data.staff %}
                                                    <tr>
                                                        <td>
                                                            <strong>{{ staff_data.staff.full_name }}</strong><br>
                                                            <small class="text-muted">{{ staff_data.staff.contact_number }}</small>
                                                        </td>
                                                        <td>{{ staff_data.staff.role }}</td>
                                                        <td>{{ staff_data.staff.get_employment_type_display }}</td>
                                                        <td>{{ staff_data.start_date }}</td>
                                                        <td>{{ staff_data.end_date|default:"-" }}</td>
                                                        <td>
                                                            <span class="badge {% if staff_data.status == 'Active' %}bg-success{% elif staff_data.status == 'Inactive' %}bg-warning{% else %}bg-danger{% endif %}">
                                                                {{ staff_data.status }}
                                                            </span>
                                                        </td>
                                                        <td>¥{{ staff_data.calculated_salary|floatformat:2 }}</td>
                                                    </tr>
                                                    {% if staff_data.dependents %}
                                                    <tr class="table-info">
                                                        <td colspan="7" class="p-0">
                                                            <div class="p-2">
                                                                <h6 class="mb-2">
                                                                    <i class="fas fa-users me-1"></i>
                                                                    Dependents of {{ staff_data.staff.full_name }}
                                                                </h6>
                                                                <div class="table-responsive overflow-auto">
                                                                    <table class="table table-sm table-bordered mb-0">
                                                                        <thead class="table-light">
                                                                            <tr>
                                                                                <th>Name</th>
                                                                                <th>Relationship</th>
                                                                                <th>Date of Birth</th>
                                                                                <th>Contact Number</th>
                                                                                <th>Address</th>
                                                                                <th>Zairyucard Number</th>
                                                                                <th>Issue Date</th>
                                                                                <th>Expiry Date</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            {% for dependent in staff_data.dependents %}
                                                                            <tr>
                                                                                <td><strong>{{ dependent.full_name }}</strong></td>
                                                                                <td>
                                                                                    <span class="badge bg-secondary">{{ dependent.relationship }}</span>
                                                                                </td>
                                                                                <td>{{ dependent.dob|default:"N/A" }}</td>
                                                                                <td>{{ dependent.contact_number|default:"N/A" }}</td>
                                                                                <td>{{ dependent.address|default:"N/A" }}</td>
                                                                                <td>{{ dependent.zairyucard_number|default:"N/A" }}</td>
                                                                                <td>{{ dependent.zairyucard_issue_date|default:"N/A" }}</td>
                                                                                <td>{{ dependent.zairyucard_expiry_date|default:"N/A" }}</td>
                                                                            </tr>
                                                                            {% endfor %}
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endif %}
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    {% else %}
                                    <p class="text-muted">No staff members found for this shop.</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="card mb-4">
                                <div class="card-body">
                                    <p class="text-muted">No shops found for this business.</p>
                                </div>
                            </div>
                        {% endif %}

                    {% elif form.is_bound %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Please select a business and date range to view transaction details.
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Use the search form above to view comprehensive transaction details for any business.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function resetForm() {
    // Reset all form fields
    const form = document.querySelector('form');
    if (form) {
        form.reset();
        
        // Clear any selected values in select elements
        const selects = form.querySelectorAll('select');
        selects.forEach(select => {
            select.selectedIndex = 0;
        });
        
        // Clear any input values
        const inputs = form.querySelectorAll('input');
        inputs.forEach(input => {
            if (input.type !== 'submit' && input.type !== 'button') {
                input.value = '';
            }
        });
    }
    
    // Redirect to the same page without query parameters to clear results
    window.location.href = window.location.pathname;
}

function downloadExcel() {
    // Get current URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const businessId = urlParams.get('business');
    const fromPeriod = urlParams.get('from_period');
    const toPeriod = urlParams.get('to_period');
    
    // Create download URL with excel parameter
    const downloadUrl = new URL(window.location.pathname, window.location.origin);
    downloadUrl.searchParams.set('business', businessId);
    downloadUrl.searchParams.set('from_period', fromPeriod);
    downloadUrl.searchParams.set('to_period', toPeriod);
    downloadUrl.searchParams.set('format', 'excel');
    
    // Trigger download
    window.location.href = downloadUrl.toString();
}
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}Monthly Rent{% endblock %}

{% block content %}
<div class="container mt-4">
    <a href="{% url 'customer:customer_detail' customer_details.customer.id %}" class="btn btn-sm btn-outline-secondary mb-3">← Back</a>

    <form method="post" action="{% url 'finance:monthly_rent' customer_details.customer.id %}" data-can-edit="{% if can_edit_fees %}true{% else %}false{% endif %}">
        {% csrf_token %}
        <div class="card shadow-sm p-4">
            <h4 class="text-center">Monthly Rent Payment</h4>
            <hr>
            <!-- Display the error massage.  -->
            {% if messages %}
                <div>
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show auto-dismiss bg-danger text-white" role="alert" style="font-size: 0.85rem; line-height: 1.2;">
                        {{ message }}
                        <button type="button button-sm" class="btn-close" data-bs-dismiss="alert" aria-label="Close" style="font-size: 0.7rem;"></button>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
            <!-- Payment Month -->
            <div class="row mb-3 align-items-center">
                <div class="col-md-2">
                    <label for="rent_month" class="form-label fw-bold mb-0">Rent Payment Month:</label>
                </div>
                <div class="col-md-3">
                    <input type="month" name="rent_month" id="rent_month" class="form-control" required>
                </div>
            </div>

            <!-- Customer & Hostel Info -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <p><strong>Full Name:</strong> {{ customer_details.customer.name }}</p>
                    <p><strong>Email:</strong> {{ customer_details.customer.email }}</p>
                    <p><strong>Phone Number:</strong> {{ customer_details.customer.phone_number }}</p>
                    <p><strong>Visa Type:</strong> {{ customer_details.customer.visa_type }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Hostel Name:</strong> {{ customer_details.unit.hostel.name }}</p>
                    <p><strong>Address:</strong> {{ customer_details.unit.hostel.address }}</p>
                    <p><strong>Room Number:</strong> {{ customer_details.unit.room_num }}</p>
                    <p><strong>Bed Number:</strong> {{ customer_details.bed_num }}</p>
                </div>
            </div>

            <!-- Privilege Notice -->
            {% if not can_edit_fees %}
            <div class="alert alert-info mb-3">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Note:</strong> You don't have permission to edit fee amounts. The values are pre-filled from bed settings.
            </div>
            {% endif %}

            <!-- Fee Inputs (Now Editable) -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Internet Fee</label>
                    <input type="number" step="0.01" name="internet" id="internetFee" class="form-control" 
                           value="{{ customer_details.internet_fee }}"
                           {% if not can_edit_fees %}readonly{% endif %}>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Utilities Fee</label>
                    <input type="number" step="0.01" name="utilities" id="utilitiesFee" class="form-control" 
                           value="{{ customer_details.utilities_fee }}"
                           {% if not can_edit_fees %}readonly{% endif %}>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Base Rent</label>
                    <input type="number" step="0.01" name="rent" id="baseRent" class="form-control" 
                           value="{{ customer_details.rent }}"
                           {% if not can_edit_fees %}readonly{% endif %}>
                </div>
            </div>

            <!-- Discount & Total -->
            <div class="row mb-3 align-items-end">
                <div class="col-md-4">
                    <label for="discount" class="form-label fw-bold">Discount (%)</label>
                    <input type="number" step="0.01" name="rent_discount_percent" id="discount" class="form-control" 
                           value="0"
                           {% if not can_edit_fees %}readonly{% endif %}>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Rent After Discount</label>
                    <p class="mt-2 mb-0">¥<span id="afterDiscount">0.00</span></p>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Total</label>
                    <p class="mt-2 mb-0">¥<span id="totalAmount">0.00</span></p>
                </div>
            </div>

            <!-- Calculation Summary Card -->
            <div class="card bg-light mb-3">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="bi bi-calculator me-2"></i>Payment Calculation Summary</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <small class="text-muted">Total Rent Amount</small>
                                <div class="h5 fw-bold text-primary mb-0">¥<span id="summaryTotalAmount">0.00</span></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <small class="text-muted" id="summaryPreviousLabel">Previous Prepaid</small>
                                <div class="h5 fw-bold text-info mb-0">¥<span id="summaryPreviousAmount">0.00</span></div>
                                <small class="text-muted" id="summaryPreviousType">Prepaid Credit</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <small class="text-muted">Amount to Collect</small>
                                <div class="h5 fw-bold text-success mb-0">¥<span id="summaryAmountToCollect">0.00</span></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <small class="text-muted">Amount Collected</small>
                                <div class="h5 fw-bold text-warning mb-0">¥<span id="summaryAmountCollected">0.00</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Previous Prepaid Amount Alert -->
            {% if previous_prepaid_amount > 0 %}
            <div class="alert alert-success border-success mb-3">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-arrow-down-circle me-2 h4 text-success"></i>
                            <div>
                                <strong class="h6">Previous Prepaid Credit Available!</strong>
                                <div class="mt-1">
                                    <span class="fw-bold text-success">¥{{ previous_prepaid_amount }}</span> from last month's payment will be deducted.
                                </div>
                                <small class="text-muted">Customer needs to pay less this month due to previous overpayment.</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-end">
                            <small class="text-muted">Amount to Collect:</small>
                            <div class="h4 fw-bold text-success mb-0">
                                ¥<span id="calculationAmountToCollect">0</span>
                            </div>
                            <small class="text-muted">(¥<span id="calculationTotalRent">{{ customer_details.rent|add:customer_details.internet_fee|add:customer_details.utilities_fee }}</span> - ¥<span id="calculationPreviousPrepaid">{{ previous_prepaid_amount|default:0 }}</span>)</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Previous Postpaid Amount Alert -->
            {% if previous_postpaid_amount > 0 %}
            <div class="alert alert-warning border-warning mb-3">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-arrow-up-circle me-2 h4 text-warning"></i>
                            <div>
                                <strong class="h6">Previous Postpaid Amount Due!</strong>
                                <div class="mt-1">
                                    <span class="fw-bold text-warning">¥{{ previous_postpaid_amount }}</span> from previous months must be paid this month.
                                </div>
                                <small class="text-muted">Customer needs to pay more this month due to previous underpayment.</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-end">
                            <small class="text-muted">Amount to Collect:</small>
                            <div class="h4 fw-bold text-warning mb-0">
                                ¥<span id="calculationAmountToCollectWithPostpaid">0</span>
                            </div>
                            <small class="text-muted">(¥<span id="calculationTotalRentWithPostpaid">{{ customer_details.rent|add:customer_details.internet_fee|add:customer_details.utilities_fee }}</span> + ¥<span id="calculationPreviousPostpaid">{{ previous_postpaid_amount|default:0 }}</span>)</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Payment Type Selection -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="payment_type" class="form-label fw-bold">Payment Type</label>
                    <select name="payment_type" id="payment_type" class="form-select" onchange="togglePaymentFields()">
                        <option value="">Normal Payment</option>
                        <option value="prepaid">Prepaid Payment</option>
                        <option value="postpaid">Postpaid Payment</option>
                    </select>
                    <small class="form-text text-muted">
                        <strong>Normal:</strong> Customer pays exact amount<br>
                        <strong>Prepaid:</strong> Customer pays more than required<br>
                        <strong>Postpaid:</strong> Customer pays less than required
                    </small>
                </div>
                <div class="col-md-6">
                    <label for="collected_amount" class="form-label fw-bold">Amount Collected from Customer</label>
                    <input type="number" step="0.01" name="collected_amount" id="collected_amount" class="form-control" 
                           placeholder="Enter amount customer actually paid"
                           {% if previous_prepaid_amount > 0 %}data-previous-prepaid="{{ previous_prepaid_amount }}"{% endif %}>
                    {% if previous_prepaid_amount > 0 %}
                    <small class="form-text text-success">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>Suggested amount:</strong> ¥<span id="suggestedAmount">0.00</span> (after deducting previous prepaid)
                    </small>
                    {% endif %}
                </div>
            </div>

            <!-- Prepaid/Postpaid Amount Field -->
            <div class="row mb-3" id="prepaid_postpaid_row" style="display: none;">
                <div class="col-md-4">
                    <label for="prepaid_amount" class="form-label fw-bold" id="prepaid_amount_label">Prepaid Amount</label>
                    <input type="number" step="0.01" name="prepaid_amount" id="prepaid_amount" class="form-control" 
                           placeholder="Enter prepaid/postpaid amount">
                    <small class="form-text text-muted" id="prepaid_amount_help">
                        Amount paid in advance or shortfall amount
                    </small>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Adjusted Total</label>
                    <p class="mt-2 mb-0">¥<span id="adjustedTotal">0.00</span></p>
                    <small class="form-text text-muted">Total rent minus previous prepaid amount</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold" id="prepaid_display_label">Prepaid Amount</label>
                    <div class="alert alert-info mb-0 p-2" id="prepaid_display_alert" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle me-2"></i>
                            <div>
                                <strong id="prepaid_display_amount">¥0.00</strong>
                                <small class="d-block text-muted" id="prepaid_display_text">Amount paid in advance</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Final Payment Summary -->
            <div class="card border-success mb-3" id="final_payment_summary" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="bi bi-check-circle me-2"></i>Final Payment Summary</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-2">
                                <small class="text-muted">Total Rent Amount:</small>
                                <span class="fw-bold ms-2">¥<span id="finalTotalRent">0.00</span></span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Previous Prepaid Amount:</small>
                                <span class="fw-bold ms-2 text-info">-¥<span id="finalPreviousPrepaid">{{ previous_prepaid_amount|default:0 }}</span></span>
                                <small class="d-block text-muted ms-4">(Deducted from this month's rent)</small>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Amount to Collect:</small>
                                <span class="fw-bold ms-2 text-success h5">¥<span id="finalAmountToCollect">0.00</span></span>
                                <small class="d-block text-muted ms-4">(Total rent minus previous prepaid)</small>
                            </div>
                            <hr>
                            <div class="mb-2">
                                <small class="text-muted">Amount Actually Collected:</small>
                                <span class="fw-bold ms-2 text-warning h5">¥<span id="finalAmountCollected">0.00</span></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-2">
                                <small class="text-muted">Payment Type:</small>
                                <span class="badge ms-2" id="finalPaymentTypeBadge">Normal</span>
                            </div>
                            <div class="mb-2" id="finalPrepaidSection" style="display: none;">
                                <small class="text-muted" id="finalPrepaidLabel">Prepaid Amount:</small>
                                <span class="fw-bold ms-2 h5" id="finalPrepaidAmount">¥0.00</span>
                            </div>
                            <div class="alert alert-light mt-3">
                                <small class="text-muted">
                                    <strong>Note:</strong> This summary shows the complete payment breakdown including any prepaid amounts that will carry forward to next month.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Memo Field (Required if discount) -->
            <div class="mb-3">
                <label for="memo" class="form-label fw-bold">Memo (required if discount applied)</label>
                <textarea name="memo" id="memo" class="form-control" rows="3"></textarea>
            </div>


            <button type="submit" class="btn btn-primary">Submit Payment</button>
        </div>
    </form>
</div>

<script>
    // Global variables
    const previousPrepaidAmount = {{ previous_prepaid_amount|default:0 }};
    const previousPostpaidAmount = {{ previous_postpaid_amount|default:0 }};
    const hadPostpaidLastMonth = {{ had_postpaid_last_month|yesno:"true,false" }};
    
    document.addEventListener('DOMContentLoaded', function () {
        const discountInput = document.getElementById('discount');
        const baseRentInput = document.getElementById('baseRent');
        const internetInput = document.getElementById('internetFee');
        const utilitiesInput = document.getElementById('utilitiesFee');
        const paymentTypeSelect = document.getElementById('payment_type');
        const collectedAmountInput = document.getElementById('collected_amount');
        const prepaidAmountInput = document.getElementById('prepaid_amount');

        const afterDiscountDisplay = document.getElementById('afterDiscount');
        const totalAmountDisplay = document.getElementById('totalAmount');
        const adjustedTotalDisplay = document.getElementById('adjustedTotal');
        
        // Summary elements
        const summaryTotalAmount = document.getElementById('summaryTotalAmount');
        const summaryAmountToCollect = document.getElementById('summaryAmountToCollect');
        const summaryAmountCollected = document.getElementById('summaryAmountCollected');
        
        // Final payment summary elements
        const finalPaymentSummary = document.getElementById('final_payment_summary');
        const finalTotalRent = document.getElementById('finalTotalRent');
        const finalAmountToCollect = document.getElementById('finalAmountToCollect');
        const finalAmountCollected = document.getElementById('finalAmountCollected');
        const finalPaymentTypeBadge = document.getElementById('finalPaymentTypeBadge');
        const finalPrepaidSection = document.getElementById('finalPrepaidSection');
        const finalPrepaidLabel = document.getElementById('finalPrepaidLabel');
        const finalPrepaidAmount = document.getElementById('finalPrepaidAmount');
        
        // Prepaid display elements
        const prepaidDisplayAlert = document.getElementById('prepaid_display_alert');
        const prepaidDisplayAmount = document.getElementById('prepaid_display_amount');
        const prepaidDisplayText = document.getElementById('prepaid_display_text');

        // Check if user can edit fees
        const canEditFees = document.querySelector('form').dataset.canEdit === 'true';

        // Make calculate function global so it can be called from AJAX callbacks
        window.calculate = function() {
            let baseRent = parseFloat(baseRentInput.value) || 0;
            let internetFee = parseFloat(internetInput.value) || 0;
            let utilitiesFee = parseFloat(utilitiesInput.value) || 0;
            let discount = parseFloat(discountInput.value) || 0;
            const collectedAmount = parseFloat(collectedAmountInput.value) || 0;
            
            // Debug logging
            console.log('Calculate function called:');
            console.log('Base rent:', baseRent);
            console.log('Internet fee:', internetFee);
            console.log('Utilities fee:', utilitiesFee);
            console.log('Previous prepaid amount:', previousPrepaidAmount);
            console.log('Previous postpaid amount:', previousPostpaidAmount);

            const discountedRent = baseRent * (1 - discount / 100);
            const total = discountedRent + internetFee + utilitiesFee;
            const adjustedTotal = Math.max(0, total - previousPrepaidAmount + previousPostpaidAmount);

            // Update basic displays
            afterDiscountDisplay.innerText = discountedRent.toFixed(2);
            totalAmountDisplay.innerText = total.toFixed(2);
            adjustedTotalDisplay.innerText = adjustedTotal.toFixed(2);

            // Update summary displays
            summaryTotalAmount.innerText = total.toFixed(2);
            summaryAmountToCollect.innerText = adjustedTotal.toFixed(2);
            summaryAmountCollected.innerText = collectedAmount.toFixed(2);
            
            // Update previous amount display based on what's available
            const summaryPreviousLabel = document.getElementById('summaryPreviousLabel');
            const summaryPreviousAmount = document.getElementById('summaryPreviousAmount');
            const summaryPreviousType = document.getElementById('summaryPreviousType');
            
            if (previousPrepaidAmount > 0) {
                summaryPreviousLabel.textContent = 'Previous Prepaid';
                summaryPreviousAmount.textContent = previousPrepaidAmount.toFixed(2);
                summaryPreviousType.textContent = 'Prepaid Credit';
                summaryPreviousAmount.className = 'h5 fw-bold text-info mb-0';
            } else if (previousPostpaidAmount > 0) {
                summaryPreviousLabel.textContent = 'Previous Postpaid';
                summaryPreviousAmount.textContent = previousPostpaidAmount.toFixed(2);
                summaryPreviousType.textContent = 'Postpaid Due';
                summaryPreviousAmount.className = 'h5 fw-bold text-warning mb-0';
            } else {
                summaryPreviousLabel.textContent = 'Previous Amount';
                summaryPreviousAmount.textContent = '0.00';
                summaryPreviousType.textContent = 'No Outstanding';
                summaryPreviousAmount.className = 'h5 fw-bold text-secondary mb-0';
            }

            // Update calculation display
            const calculationTotalRent = document.getElementById('calculationTotalRent');
            const calculationPreviousPrepaid = document.getElementById('calculationPreviousPrepaid');
            const calculationAmountToCollect = document.getElementById('calculationAmountToCollect');
            const calculationTotalRentWithPostpaid = document.getElementById('calculationTotalRentWithPostpaid');
            const calculationPreviousPostpaid = document.getElementById('calculationPreviousPostpaid');
            const calculationAmountToCollectWithPostpaid = document.getElementById('calculationAmountToCollectWithPostpaid');
            const suggestedAmount = document.getElementById('suggestedAmount');
            
            if (calculationTotalRent && calculationAmountToCollect) {
                calculationTotalRent.textContent = total.toFixed(2);
                calculationAmountToCollect.textContent = adjustedTotal.toFixed(2);
            }
            
            if (calculationTotalRentWithPostpaid && calculationPreviousPostpaid && calculationAmountToCollectWithPostpaid) {
                calculationTotalRentWithPostpaid.textContent = total.toFixed(2);
                calculationPreviousPostpaid.textContent = previousPostpaidAmount.toFixed(2);
                calculationAmountToCollectWithPostpaid.textContent = adjustedTotal.toFixed(2);
            }
            
            // Update suggested amount
            if (suggestedAmount) {
                suggestedAmount.textContent = adjustedTotal.toFixed(2);
            }

            // Update final payment summary
            updateFinalPaymentSummary(total, adjustedTotal, collectedAmount);

            // Auto-calculate prepaid/postpaid amount based on collected amount
            updatePrepaidAmount(adjustedTotal);
        }

        function updateFinalPaymentSummary(total, adjustedTotal, collectedAmount) {
            const paymentType = paymentTypeSelect.value;
            
            // Update final summary values
            finalTotalRent.innerText = total.toFixed(2);
            finalAmountToCollect.innerText = adjustedTotal.toFixed(2);
            finalAmountCollected.innerText = collectedAmount.toFixed(2);
            
            // Update payment type badge
            if (paymentType === 'prepaid') {
                finalPaymentTypeBadge.className = 'badge bg-info ms-2';
                finalPaymentTypeBadge.textContent = 'Prepaid Payment';
            } else if (paymentType === 'postpaid') {
                finalPaymentTypeBadge.className = 'badge bg-warning ms-2';
                finalPaymentTypeBadge.textContent = 'Postpaid Payment';
            } else {
                finalPaymentTypeBadge.className = 'badge bg-success ms-2';
                finalPaymentTypeBadge.textContent = 'Normal Payment';
            }
            
            // Update prepaid section
            if (paymentType && collectedAmount > 0) {
                const prepaidAmount = parseFloat(prepaidAmountInput.value) || 0;
                if (prepaidAmount > 0) {
                    finalPrepaidSection.style.display = 'block';
                    finalPrepaidAmount.textContent = '¥' + prepaidAmount.toFixed(2);
                    
                    if (paymentType === 'prepaid') {
                        finalPrepaidLabel.textContent = 'Prepaid Amount:';
                        finalPrepaidAmount.className = 'fw-bold ms-2 h5 text-info';
                    } else if (paymentType === 'postpaid') {
                        finalPrepaidLabel.textContent = 'Postpaid Amount:';
                        finalPrepaidAmount.className = 'fw-bold ms-2 h5 text-warning';
                    }
                } else {
                    finalPrepaidSection.style.display = 'none';
                }
            } else {
                finalPrepaidSection.style.display = 'none';
            }
            
            // Show final summary if there's any meaningful data
            if (collectedAmount > 0 || paymentType) {
                finalPaymentSummary.style.display = 'block';
            } else {
                finalPaymentSummary.style.display = 'none';
            }
        }

        function updatePrepaidAmount(adjustedTotal) {
            const paymentType = paymentTypeSelect.value;
            const collectedAmount = parseFloat(collectedAmountInput.value) || 0;
            
            if (paymentType === 'prepaid' && collectedAmount > 0) {
                const expectedPrepaid = collectedAmount - adjustedTotal;
                const prepaidAmount = expectedPrepaid > 0 ? expectedPrepaid : 0;
                prepaidAmountInput.value = prepaidAmount.toFixed(2);
                
                // Update prepaid display alert
                if (prepaidAmount > 0) {
                    prepaidDisplayAlert.style.display = 'block';
                    prepaidDisplayAmount.textContent = '¥' + prepaidAmount.toFixed(2);
                    prepaidDisplayText.textContent = 'Amount paid in advance (will carry forward to next month)';
                    prepaidDisplayAlert.className = 'alert alert-info mb-0 p-2';
                } else {
                    prepaidDisplayAlert.style.display = 'none';
                }
            } else if (paymentType === 'postpaid' && collectedAmount > 0) {
                const expectedPostpaid = adjustedTotal - collectedAmount;
                const postpaidAmount = expectedPostpaid > 0 ? expectedPostpaid : 0;
                prepaidAmountInput.value = postpaidAmount.toFixed(2);
                
                // Update prepaid display alert
                if (postpaidAmount > 0) {
                    prepaidDisplayAlert.style.display = 'block';
                    prepaidDisplayAmount.textContent = '¥' + postpaidAmount.toFixed(2);
                    prepaidDisplayText.textContent = 'Amount carried forward (will be added to next month\'s rent)';
                    prepaidDisplayAlert.className = 'alert alert-warning mb-0 p-2';
                } else {
                    prepaidDisplayAlert.style.display = 'none';
                }
            } else if (paymentType === '') {
                // For normal payment, set collected amount to adjusted total (after prepaid deduction)
                if (previousPrepaidAmount > 0 && collectedAmountInput.value === '') {
                    collectedAmountInput.value = adjustedTotal.toFixed(2);
                } else if (previousPrepaidAmount === 0) {
                    collectedAmountInput.value = adjustedTotal.toFixed(2);
                }
                // Clear prepaid amount field for normal payments
                prepaidAmountInput.value = '0.00';
                prepaidDisplayAlert.style.display = 'none';
            } else {
                prepaidDisplayAlert.style.display = 'none';
            }
        }

        function togglePaymentFields() {
            const paymentType = paymentTypeSelect.value;
            const prepaidRow = document.getElementById('prepaid_postpaid_row');
            const prepaidLabel = document.getElementById('prepaid_amount_label');
            const prepaidHelp = document.getElementById('prepaid_amount_help');
            const collectedAmount = document.getElementById('collected_amount');
            
            if (paymentType === 'prepaid') {
                prepaidRow.style.display = 'block';
                prepaidLabel.textContent = 'Prepaid Amount';
                prepaidHelp.textContent = 'Amount paid in advance (excess over total rent)';
                collectedAmount.placeholder = 'Enter amount customer paid (should be ≥ total rent)';
                collectedAmount.required = true;
                prepaidAmountInput.required = true;
            } else if (paymentType === 'postpaid') {
                prepaidRow.style.display = 'block';
                prepaidLabel.textContent = 'Postpaid Amount';
                prepaidHelp.textContent = 'Amount carried forward (shortfall from total rent)';
                collectedAmount.placeholder = 'Enter amount customer paid (should be < total rent)';
                collectedAmount.required = true;
                prepaidAmountInput.required = true;
            } else {
                prepaidRow.style.display = 'none';
                collectedAmount.placeholder = 'Enter amount customer actually paid';
                collectedAmount.required = false;
                prepaidAmountInput.required = false;
                prepaidAmountInput.value = '';
            }
            
            calculate();
        }

        // Add event listeners to all relevant inputs only if editable
        if (canEditFees) {
            [discountInput, baseRentInput, internetInput, utilitiesInput, paymentTypeSelect, collectedAmountInput].forEach(input => {
                input.addEventListener('input', calculate);
            });
        }

        // Disable postpaid option if customer had postpaid last month
        if (hadPostpaidLastMonth) {
            const postpaidOption = paymentTypeSelect.querySelector('option[value="postpaid"]');
            if (postpaidOption) {
                postpaidOption.disabled = true;
                postpaidOption.textContent = 'Postpaid Payment (Not allowed - had postpaid last month)';
            }
        }

        // Initial calculation
        calculate();
    });


    // Auto-dismiss messages after 5 seconds
    setTimeout(() => {
      const alerts = document.querySelectorAll('.auto-dismiss');
      alerts.forEach(alert => {
        const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
        bsAlert.close();
      });
    }, 4000);

    document.querySelector('form').addEventListener('submit', function (e) {
        const rentDiscount = document.getElementById('discount');
        const memo = document.getElementById('memo');
        const paymentType = document.getElementById('payment_type');
        const collectedAmount = document.getElementById('collected_amount');
        const prepaidAmount = document.getElementById('prepaid_amount');
        const adjustedTotalDisplay = document.getElementById('adjustedTotal');

        const discountApplied = parseFloat(rentDiscount.value || "0") > 0;
        const adjustedTotal = parseFloat(adjustedTotalDisplay.textContent || "0");

        // Check memo requirement for discount
        if (discountApplied && memo.value.trim() === "") {
            e.preventDefault();
            alert("Memo is required when a discount is applied.");
            memo.focus();
            return;
        }

        // Validate payment type logic
        if (paymentType.value === 'prepaid') {
            const collected = parseFloat(collectedAmount.value || "0");
            if (collected < adjustedTotal) {
                e.preventDefault();
                alert(`For prepaid payment, collected amount must be greater than or equal to adjusted total rent amount (¥${adjustedTotal.toFixed(2)}).`);
                collectedAmount.focus();
                return;
            }
            const expectedPrepaid = collected - adjustedTotal;
            const enteredPrepaid = parseFloat(prepaidAmount.value || "0");
            if (Math.abs(enteredPrepaid - expectedPrepaid) > 0.01) {
                e.preventDefault();
                alert(`Prepaid amount should be ¥${expectedPrepaid.toFixed(2)} (excess of collected amount over adjusted total rent).`);
                prepaidAmount.focus();
                return;
            }
        } else if (paymentType.value === 'postpaid') {
            const collected = parseFloat(collectedAmount.value || "0");
            if (collected >= adjustedTotal) {
                e.preventDefault();
                alert(`For postpaid payment, collected amount must be less than adjusted total rent amount (¥${adjustedTotal.toFixed(2)}).`);
                collectedAmount.focus();
                return;
            }
            const expectedPostpaid = adjustedTotal - collected;
            const enteredPostpaid = parseFloat(prepaidAmount.value || "0");
            if (Math.abs(enteredPostpaid - expectedPostpaid) > 0.01) {
                e.preventDefault();
                alert(`Postpaid amount should be ¥${expectedPostpaid.toFixed(2)} (shortfall of adjusted total rent over collected amount).`);
                prepaidAmount.focus();
                return;
            }
        } else if (paymentType.value === '') {
            const collected = parseFloat(collectedAmount.value || "0");
            if (Math.abs(collected - adjustedTotal) > 0.01) {
                e.preventDefault();
                alert(`For normal payment, collected amount must equal amount to collect (¥${adjustedTotal.toFixed(2)}).`);
                collectedAmount.focus();
                return;
            }
        }

        const confirmed = confirm("Are you sure you want to make this transaction?");
        if (!confirmed) {
            e.preventDefault();
        }
    });
</script>
{% endblock %}
